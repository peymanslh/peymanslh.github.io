<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>date_trunc function in PostgreSQL - Peyman Salehi</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://peyman.blog/favicon.png><link rel=alternate type=application/rss+xml href=https://peyman.blog/index.xml title="Peyman Salehi"><link rel=stylesheet href=/css/style.min.0d95cf45668059f810b4c9368f42c38f1809cbd8d45cc13edd2b6bea820b8f19.css><meta name=description content="Use date_trunc function in PostgreSQL to get a series of data based on a specific interval."><meta property="og:title" content="date_trunc function in PostgreSQL"><meta property="og:type" content="website"><meta property="og:url" content="https://peyman.blog/posts/date-trunc-function-in-postgresql/"><meta property="og:description" content="Use date_trunc function in PostgreSQL to get a series of data based on a specific interval."><meta name=twitter:card content="summary"><meta name=twitter:site content="@_peymanslh"><meta name=twitter:creator content="@_peymanslh"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,500;0,700;1,500&family=Libre+Caslon+Text:wght@700&family=Pridi:wght@300;400;600;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=wrapper class=wrapper><div class=header><a class=header-logo href=https://peyman.blog/>Peyman Salehi</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/>About</a></li><li class=menu-item-posts><a href=/posts/>Posts</a></li></ul></div></div><div class=blog><div class=intro><h1>date_trunc function in PostgreSQL<span class=dot>.</span></h1></div><div class=content><p>Recently I needed to write a query in SQL to retrieve a bunch of data from a big table with a specific interval. And I don&rsquo;t know, is there any easier way in SQL to do this but I found <code>date_trunc</code> function in PostgreSQL that is an excellent solution for my problem.</p><h1 id=the-problem-with-an-example>The problem with an example</h1><p>Consider the following table.</p><table><thead><tr><th>id</th><th>datetime</th><th>flight</th><th>price</th></tr></thead><tbody><tr><td>1</td><td>2023-03-07 12:45:12.231069+00</td><td>AB12</td><td>300</td></tr><tr><td>2</td><td>2023-03-07 12:50:23.341069+00</td><td>AB12</td><td>295</td></tr><tr><td>3</td><td>2023-03-07 13:10:19.241069+00</td><td>AB12</td><td>295</td></tr><tr><td>4</td><td>2023-03-07 13:33:45.321069+00</td><td>AB12</td><td>299</td></tr><tr><td>6</td><td>2023-03-07 13:51:58.311069+00</td><td>AB12</td><td>299</td></tr><tr><td>7</td><td>2023-03-07 13:58:47.141069+00</td><td>AB12</td><td>298</td></tr><tr><td>8</td><td>2023-03-07 14:15:19.151069+00</td><td>AB12</td><td>286</td></tr><tr><td>9</td><td>2023-03-07 14:39:55.221069+00</td><td>AB12</td><td>289</td></tr><tr><td>10</td><td>2023-03-07 15:48:29.111069+00</td><td>AB12</td><td>289</td></tr><tr><td>..</td><td>..</td><td>..</td><td>..</td></tr></tbody></table><p>And, we want to fetch one row per hour(or the last price for each hour) for flight <code>AB12</code>.
The output should be something like this.</p><table><thead><tr><th>datetime</th><th>flight</th><th>price</th></tr></thead><tbody><tr><td>2023-03-07 12:00:00.000000+00</td><td>AB12</td><td>295</td></tr><tr><td>2023-03-07 13:00:00.000000+00</td><td>AB12</td><td>298</td></tr><tr><td>2023-03-07 14:00:00.000000+00</td><td>AB12</td><td>289</td></tr><tr><td>2023-03-07 15:00:00.000000+00</td><td>AB12</td><td>289</td></tr></tbody></table><h1 id=date_trunc-function>date_trunc function</h1><p><code>date_trunc</code> function is simply truncating a <code>datetime</code> object based on an input.<br>Usage:</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>date_trunc<span style=color:#eceff4>(</span>_<span style=color:#81a1c1>`</span>field<span style=color:#81a1c1>`</span>_<span style=color:#eceff4>,</span> _<span style=color:#81a1c1>`</span><span style=color:#81a1c1;font-weight:700>source</span><span style=color:#81a1c1>`</span>_ <span style=color:#eceff4>[,</span> _<span style=color:#81a1c1>`</span>time_zone<span style=color:#81a1c1>`</span>_ <span style=color:#eceff4>])</span>
</span></span></code></pre></div><p><code>field</code> can be any value of the following list:</p><ul><li><code>microseconds</code></li><li><code>milliseconds</code></li><li><code>second</code></li><li><code>minute</code></li><li><code>hour</code></li><li><code>day</code></li><li><code>week</code></li><li><code>month</code></li><li><code>quarter</code></li><li><code>year</code></li><li><code>decade</code></li><li><code>century</code></li><li><code>millennium</code></li></ul><p>And, <code>source</code> can be a column name or a value.<br>Example from <a href=https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-TRUNC>PostgreSQL documentation</a>:</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span> date_trunc<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;hour&#39;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>TIMESTAMP</span> <span style=color:#a3be8c>&#39;2001-02-16 20:38:40&#39;</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>-- Result: 2001-02-16 20:00:00
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span> date_trunc<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;year&#39;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>TIMESTAMP</span> <span style=color:#a3be8c>&#39;2001-02-16 20:38:40&#39;</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>-- Result: 2001-01-01 00:00:00
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span> date_trunc<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;day&#39;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>TIMESTAMP</span> <span style=color:#81a1c1;font-weight:700>WITH</span> TIME <span style=color:#81a1c1;font-weight:700>ZONE</span> <span style=color:#a3be8c>&#39;2001-02-16 20:38:40+00&#39;</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>-- Result: 2001-02-16 00:00:00-05
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span> date_trunc<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;day&#39;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>TIMESTAMP</span> <span style=color:#81a1c1;font-weight:700>WITH</span> TIME <span style=color:#81a1c1;font-weight:700>ZONE</span> <span style=color:#a3be8c>&#39;2001-02-16 20:38:40+00&#39;</span><span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#39;Australia/Sydney&#39;</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>-- Result: 2001-02-16 08:00:00-05
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span> date_trunc<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;hour&#39;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>INTERVAL</span> <span style=color:#a3be8c>&#39;3 days 02:47:33&#39;</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>-- Result: 3 days 02:00:00
</span></span></span></code></pre></div><h1 id=solution-to-my-problem>Solution to my problem</h1><p><code>date_trunc</code> is great for working with <code>datetime</code>, but it does not end up here. We can use it in our queries to fetch data with a specific interval based on <code>field</code> argument to this function.
The following SQL query gives us the output that we expect.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>SELECT</span>
</span></span><span style=display:flex><span>  DATE_TRUNC<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;hour&#39;</span><span style=color:#eceff4>,</span> datetime<span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>AS</span> datetime<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>  TO_JSON<span style=color:#eceff4>(</span>ARRAY_AGG<span style=color:#eceff4>(</span>flight<span style=color:#eceff4>))</span><span style=color:#81a1c1>-&gt;-</span><span style=color:#b48ead>1</span> <span style=color:#81a1c1;font-weight:700>AS</span> flight<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>  TO_JSON<span style=color:#eceff4>(</span>ARRAY_AGG<span style=color:#eceff4>(</span>price <span style=color:#81a1c1;font-weight:700>ORDER</span> <span style=color:#81a1c1;font-weight:700>BY</span> datetime <span style=color:#81a1c1;font-weight:700>ASC</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>-&gt;-</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>FROM</span>
</span></span><span style=display:flex><span>    flights
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>WHERE</span>
</span></span><span style=display:flex><span>    flight <span style=color:#81a1c1>=</span> <span style=color:#a3be8c>&#39;AB12&#39;</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>GROUP</span> <span style=color:#81a1c1;font-weight:700>BY</span>
</span></span><span style=display:flex><span>    DATE_TRUNC<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#39;hour&#39;</span><span style=color:#eceff4>,</span> datetime<span style=color:#eceff4>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Query explanation:<br>Line 2: We use <code>date_trunc</code> in the select statement to get a truncated <code>datetime</code>.<br>Line 3: For each hour we have multiple rows, for example at 13:00 we have four rows of data and we need to choose one of them for output, or use an aggregate function like <code>count</code> or <code>avg</code>, but here we want the last row and we can use <code>to_json</code> and <code>array_agg</code> to get the item we want.<br>Line 4: Same as the previous line, but we used sorting based on <code>datetime</code> to get the last price of each hour.<br>And finally, in the last line, we use <code>date_trunc</code> in our group statement to group data based on the hour.<br>Our output should be something like this:</p><table><thead><tr><th>datetime</th><th>flight</th><th>price</th></tr></thead><tbody><tr><td>2023-03-07 12:00:00.000000+00</td><td>AB12</td><td>295</td></tr><tr><td>2023-03-07 13:00:00.000000+00</td><td>AB12</td><td>298</td></tr><tr><td>2023-03-07 14:00:00.000000+00</td><td>AB12</td><td>289</td></tr><tr><td>2023-03-07 15:00:00.000000+00</td><td>AB12</td><td>289</td></tr></tbody></table></div></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//peymanslh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=footer><div class=footer-copy>© 2023 Peyman Salehi.</div><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/_peymanslh title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter>
</a></span><span class="social-icon social-icon-github"><a href=https://github.com/peymanslh title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github>
</a></span><span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/peymanslh title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js></script></body></html>